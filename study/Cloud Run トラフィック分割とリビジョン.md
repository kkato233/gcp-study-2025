[🏠 ホーム: Google Cloud 認定資格 Profesional Developer 勉強資料](../index.md)

# Cloud Run: トラフィック分割とリビジョン まとめ

## 要約
- 「トラフィック分割」は、単一サービス内で複数リビジョンへ割合で配信する機能。
- 「リビジョンを増やす」だけでは同時配信にはならず、最新リビジョンが100%受け持つ。
- A/B/C テストは「1サービス＋複数リビジョン＋トラフィック分割」が最も簡単。
- ユーザ固定が必要な場合は「タグURL＋Cookie」で擬似スティッキー、または「別サービス＋外部LB」で厳密制御。

## 用語の整理
- サービス: エンドポイント（URL）単位のデプロイ対象。1つのサービスに複数リビジョンを保持。
- リビジョン: デプロイごとに作成される不変の実行バージョン。
- トラフィック分割: サービスURLへのリクエストを、複数リビジョンへ割合で振り分ける設定。
- タグ: リビジョンに付与できる別名。タグ付き専用URL（`https://TAG---SERVICE-…a.run.app`）で直接アクセス可。

## 「トラフィック分割」vs「3つの個別リビジョンとしてデプロイ」
- トラフィック分割を使用
  - 同一サービスの同一URLで、複数リビジョンに 例: 33/33/34% で配信。
  - 段階リリースや簡易A/B/Cに最適。ユーザ単位の固定はデフォルトなし（リクエストごとの確率）。
- 3つの個別リビジョンとしてデプロイ
  - リビジョンは作成されるが、分割設定がなければ最新が100%。
  - 同時配信にするには結局「トラフィック分割」設定が必要。タグを付ければ別URLで直接アクセス可。

## A/B/C テストの選び方
- 最小運用: 1サービス＋複数リビジョン＋トラフィック分割。
- ユーザ固定が必要: タグURLを用意し、初回にCookieで割当（verA/B/C）→ 以後は該当タグURLへリダイレクト。
- 厳密なルール/スティッキー: 別サービス（A/B/C）を作成し、外部HTTP(S) LB＋Serverless NEGでCookie/ヘッダ/地理等に基づくルーティング。

## URLとドメインの挙動
- デフォルトURL: サービスごとに1つ（例: `https://SERVICE-…a.run.app`）。
- リビジョン固有URL: デフォルトは無し。タグを付けるとタグ付きURLが払い出される。
- トラフィック分割無し: サービスURL1本のみ（別ドメインにはならない）。
- カスタムドメイン: サービスに割当可能。タグ付きURLに対して個別のサブドメイン割当も運用設計で可能。

## 設定コマンド例（PowerShell）
- 割合分割（3リビジョンを 33/33/34%）
```pwsh
gcloud run services update-traffic <SERVICE_NAME> `
  --region=<REGION> `
  --to-revisions <REV_A>=33,<REV_B>=33,<REV_C>=34
```
- タグ付け（タグURLを有効化）
```pwsh
gcloud run services update-traffic <SERVICE_NAME> `
  --region=<REGION> `
  --tag <REV_A>=verA `
  --tag <REV_B>=verB `
  --tag <REV_C>=verC
```

## 擬似スティッキー（タグURL＋Cookie）パターン
1. 初回アクセス時にユーザを verA/B/C に割当（乱数 or ハッシュ）。
2. Cookie（例: `ab_variant=verB; Max-Age=90d`）を発行。
3. 次回以降は Cookie を見て `https://verB---<SERVICE_URL>` へ 302 リダイレクト。
4. Cloud Run 側はタグ付きURLで該当リビジョンを必ず配信。

## よくある注意点
- Cloud Run 単体に“セッションスティッキー”は無い（割合分割はリクエスト単位）。
- リリース段階で 0%/100% を切り替えると、即時にトラフィックが移行する。
- 各リビジョンはメモリ/CPU/同時実行/環境変数を個別設定できるが、完全独立運用が必要なら別サービス化が明瞭。
- ログ/メトリクスはリビジョン/タグ単位で観測可能。計測設計（Cookie/ヘッダ）を合わせておくと分析が楽。

[🏠 ホーム: Google Cloud 認定資格 Profesional Developer 勉強資料](../index.md)
